

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Signature Matrix Creation &mdash; TumorDecon 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=2709fde1"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Running Digital Cytometry" href="digital-cytometry.html" />
    <link rel="prev" title="Data Inputs" href="data-input.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            TumorDecon
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="about.html">About TumorDecon</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data-input.html">Data Inputs</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Signature Matrix Creation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#batch_correct_datasets"><code class="docutils literal notranslate"><span class="pre">batch_correct_datasets()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#create_signature_matrix"><code class="docutils literal notranslate"><span class="pre">create_signature_matrix()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="digital-cytometry.html">Running Digital Cytometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Post-processing &amp; Visualization</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">TumorDecon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Signature Matrix Creation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/sigmatrix.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="signature-matrix-creation">
<span id="custom-signature"></span><h1>Signature Matrix Creation<a class="headerlink" href="#signature-matrix-creation" title="Link to this heading"></a></h1>
<dl class="py function">
<dt class="sig sig-object py" id="batch_correct_datasets">
<span class="sig-name descname"><span class="pre">batch_correct_datasets</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data_loc</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cell_file_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">outfile</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'batch_corrected_datasets.txt'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#batch_correct_datasets" title="Link to this definition"></a></dt>
<dd><p>Performs batch correction on raw data files, and saves the combined output to a single CSV file. All files must be stored in the same folder.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_loc</strong> – String. Path to folder that holds all data files</p></li>
<li><p><strong>cell_file_dict</strong> – Dictionary. Keys = Cell Types, Values = paths to all raw files containing data for the given cell type</p></li>
<li><p><strong>outfile</strong> – String. Name to save the batch corrected datasets file under. Default is “batch_corrected_datasets.txt”</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>None. Batch corrected datasets are written to a text file</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="create_signature_matrix">
<span class="sig-name descname"><span class="pre">create_signature_matrix</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">infile</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cell_types</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">clustered</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_clusters</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">intermfile</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">outfile</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'kmeans_signature_matrix_qval.txt'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#create_signature_matrix" title="Link to this definition"></a></dt>
<dd><p>Given a batch corrected dataset as input (such as one created with <code class="docutils literal notranslate"><span class="pre">batch_correct_datasets()</span></code>), runs clustering on each cell-type (using the silhouette method), does differential expression analysis to get the genes that are significantly expressed among each cluster (using adjusted p value), and outputs a signature matrix to a csv file.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>infile</strong> – String. Path to text file containing the batch corrected datasets</p></li>
<li><p><strong>cell_types</strong> – List of cell types (strings) to include in signature matrix</p></li>
<li><p><strong>clustered</strong> – Boolean. Whether or not the infile is pre-clustered</p></li>
<li><p><strong>max_clusters</strong> – Integer. Maximum value of K to try for k-means clustering. Ignored if <code class="docutils literal notranslate"><span class="pre">clustered=True</span></code></p></li>
<li><p><strong>intermfile</strong> – String. Where to save intermediate step of clustered batch corrected datasets. Ignored if <code class="docutils literal notranslate"><span class="pre">clustered=True</span></code>. Default is <code class="docutils literal notranslate"><span class="pre">infile+&quot;_clustered.txt&quot;</span></code></p></li>
<li><p><strong>outfile</strong> – String. Name to save the finished signature matrix file under. Default is “kmeans_signature_matrix_qval.txt”</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>None. Signature matrix and (if <code class="docutils literal notranslate"><span class="pre">clustered=False</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">intermfile</span> <span class="pre">!=</span> <span class="pre">None</span></code>) text file of clustered batch corrected datasets are written to csv files</p>
</dd>
</dl>
</dd></dl>

<p><strong>Example:</strong> Create a custom signature matrix from raw data files. The data used in this example are single cell profiles from the Gene Expression Omnibus (GEO) repository. They are available to download on the NCBI website, as well as from our GitHub page, at: <a class="reference external" href="https://github.com/ShahriyariLab/TumorDecon/tree/master/TumorDecon/data/sig_matrix_tutorial">https://github.com/ShahriyariLab/TumorDecon/tree/master/TumorDecon/data/sig_matrix_tutorial</a> :</p>
<p>To begin, we define a dictionary where the keys are the cell types we wish to consider, and the values are all the raw files that contain data for that cell type:</p>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; cell_file_dict = {&#39;CD4&#39;: [&#39;GSE107011_Processed_data_TPM2.txt&#39;, &#39;ensembl_version_GSE97861.txt&#39;, &#39;ensembl_version_GSE97862.txt&#39;, \
                              &#39;ensembl_version_GSE113891.txt&#39;, &#39;ensembl_version_GSE114407.txt&#39;, &#39;ensembl_version_GSE115978.txt&#39;], \
                              &#39;CD8&#39;: [&#39;ensembl_version_GSE98638.txt&#39;, &#39;ensembl_version_GSE114407.txt&#39;, &#39;GSE107011_Processed_data_TPM2.txt&#39;], \
                              &#39;B_&#39;: [&#39;GSE107011_Processed_data_TPM2.txt&#39;, &#39;ensembl_version_GSE114407.txt&#39;, &#39;ensembl_version_GSE115978.txt&#39;], \
                              &#39;mono&#39;: [&#39;ensembl_version_GSE114407.txt&#39;, &#39;GSE107011_Processed_data_TPM2.txt&#39;], \
                              &#39;NK&#39;: [&#39;GSE107011_Processed_data_TPM2.txt&#39;, &#39;ensembl_version_GSE115978.txt&#39;], \
                              &#39;Endo&#39;: [&#39;ensembl_version_GSE102767.txt&#39;, &#39;ensembl_version_GSE113839.txt&#39;, &#39;ensembl_version_GSE115978.txt&#39;], \
                              &#39;Fibro&#39;: [&#39;ensembl_version_GSE113839.txt&#39;, &#39;GSE109448_rnaseq_gene_tpm.tsv&#39;, &#39;GSE109449_singlecell_rnaseq_gene_tpm.txt&#39;], \
                              &#39;Neutro&#39;: [&#39;GSE107011_Processed_data_TPM2.txt&#39;]}
</pre></div>
</div>
<p>Next, remove batch effects with the <code class="docutils literal notranslate"><span class="pre">batch_correct_datasets()</span></code> function. In the following example, we have saved all the GEO files to “datafolder” and we wish to save the batch corrected data under the name “batch_corrected_sample_data.txt”:</p>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; td.batch_correct_datasets(&quot;datafolder&quot;, cell_file_dict, outfile=&quot;batch_corrected_sample_data.txt&quot;)
Performing batch correction...
Found 6 batches.
Adjusting for 0 covariate(s) or covariate level(s).
Standardizing Data across genes.
Fitting L/S model and finding priors.
Finding parametric adjustments.
Adjusting the Data
Found 3 batches.
Adjusting for 0 covariate(s) or covariate level(s).
Standardizing Data across genes.
Fitting L/S model and finding priors.
Finding parametric adjustments.
Adjusting the Data

[ ... output truncated for space ... ]

Found 3 batches.
Adjusting for 0 covariate(s) or covariate level(s).
Standardizing Data across genes.
Fitting L/S model and finding priors.
Finding parametric adjustments.
Adjusting the Data
Saving batch corrected datasets to batch_corrected_sample_data.txt...
</pre></div>
</div>
<p>Once batch effects are removed, use the data to create a signature matrix:</p>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; cell_types_to_include = [&quot;CD8&quot;, &quot;CD4&quot;, &quot;B_cell&quot;, &quot;NK&quot;, &quot;mono&quot;, &quot;Endothelial&quot;, &quot;Fibroblast&quot;, &quot;Neutrophils&quot;]
&gt;&gt;&gt; td.create_signature_matrix(&quot;batch_corrected_sample_data.txt&quot;, cell_types_to_include, outfile=&quot;kmeans_signature_matrix_qval.txt&quot;)
Reading batch-corrected dataset file batch_corrected_sample_data.txt...
Clustering batch-corrected datasets...
CD8: Finding optimal K for K-means (max # of clusters = 10)
Optimal K = 2
CD4: Finding optimal K for K-means (max # of clusters = 10)
Optimal K = 2
B_cell: Finding optimal K for K-means (max # of clusters = 10)
Optimal K = 2
NK: Finding optimal K for K-means (max # of clusters = 10)
Optimal K = 2
mono: Finding optimal K for K-means (max # of clusters = 10)
Optimal K = 2
Endothelial: Finding optimal K for K-means (max # of clusters = 10)
Optimal K = 2
Fibroblast: Finding optimal K for K-means (max # of clusters = 10)
Optimal K = 2
Neutrophils: Finding optimal K for K-means (max # of clusters = 10)
Optimal K = 2
Saving clustered data sets to batch_corrected_sample_data_clustered.txt...
Generating signature matrix from clustered batch-corrected datasets...
Saving signature matrix to kmeans_signature_matrix_qval.txt...
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">create_signature_matrix()</span></code> function expects a non-clustered data file as input. However, if your datafile is large, running these two processes (clustering &amp; generation of signature matrix) in sequence can take a very long time, or you may run into memory issues. To avoid this, you can also input an already-clustered data file (saved as an intermediate step in a previous run), and include the argument <code class="docutils literal notranslate"><span class="pre">clustered=True</span></code>, in order to skip the clustering step:</p>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; td.create_signature_matrix(&quot;batch_corrected_sample_data_clustered.txt&quot;, cell_types_to_include, clustered=True, outfile=&quot;kmeans_signature_matrix_qval_2.txt&quot;)
Reading batch-corrected dataset file batch_corrected_sample_data_clustered.txt...
Generating signature matrix from clustered batch-corrected datasets...
Saving signature matrix to kmeans_signature_matrix_qval_2.txt...
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="data-input.html" class="btn btn-neutral float-left" title="Data Inputs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="digital-cytometry.html" class="btn btn-neutral float-right" title="Running Digital Cytometry" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright workshop participant.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>